<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }

        /* Êï¥‰ΩìÂ∏ÉÂ±Ä */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 280px;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2d2d44;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .new-chat-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® */
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #3d3d5c;
            border-radius: 3px;
        }

        .history-section {
            margin-bottom: 16px;
        }

        .history-section-title {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            font-weight: 600;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 4px;
            transition: background 0.2s;
            position: relative;
        }

        .history-item:hover {
            background: #2d2d44;
        }

        .history-item.active {
            background: #3d3d5c;
        }

        .history-item-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: #3d3d5c;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0a0b0;
        }

        .history-item-content {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .history-item-title {
            font-size: 13px;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .history-item-meta {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-item-school {
            background: #3d3d5c;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .history-item-delete {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            background: #dc3545;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .history-item:hover .history-item-delete {
            opacity: 1;
        }

        .history-item-delete:hover {
            background: #c82333;
        }

        /* ‰æßËæπÊ†èÂ∫ïÈÉ® */
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #2d2d44;
        }

        .storage-info {
            font-size: 11px;
            color: #6c757d;
            text-align: center;
        }

        .clear-all-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px solid #3d3d5c;
            color: #a0a0b0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .clear-all-btn:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        /* Â§¥ÈÉ® */
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* ‰∏ªËÅäÂ§©Âå∫Âüü */
        .chat-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        /* È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .school-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .school-selector label {
            font-size: 13px;
            color: #495057;
            font-weight: 500;
        }

        .school-selector select {
            padding: 6px 28px 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23495057' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }

        .school-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .session-info {
            font-size: 11px;
            color: #6c757d;
        }

        .toolbar-actions {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            padding: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            color: #6c757d;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: #e9ecef;
            color: #495057;
        }

        /* ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 0;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ced4da;
            border-radius: 3px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: white;
            color: #212529;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Markdown content styles */
        .message.assistant .message-bubble h2,
        .message.assistant .message-bubble h3,
        .message.assistant .message-bubble h4 {
            color: #333;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .message.assistant .message-bubble h2:first-child,
        .message.assistant .message-bubble h3:first-child,
        .message.assistant .message-bubble h4:first-child {
            margin-top: 0;
        }

        .message.assistant .message-bubble strong {
            font-weight: 600;
            color: #333;
        }

        .message.assistant .message-bubble li {
            margin: 4px 0;
            padding-left: 4px;
        }

        .message.assistant .message-bubble table {
            font-size: 13px;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
        }

        .message.assistant .message-bubble table tr:first-child td {
            background: #f0f0f0;
            font-weight: 600;
        }

        .message.assistant .message-bubble a {
            color: #667eea;
            text-decoration: none;
        }

        .message.assistant .message-bubble a:hover {
            text-decoration: underline;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            font-size: 11px;
            color: #6c757d;
        }

        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .source-badge.knowledge-base {
            background: #d4edda;
            color: #155724;
        }

        .source-badge.web-search {
            background: #cce5ff;
            color: #004085;
        }

        /* Êù•Ê∫êÂºïÁî®Âå∫Âüü */
        .sources-container {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .sources-title {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .source-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .source-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .source-index {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .source-content {
            flex: 1;
            min-width: 0;
        }

        .source-link {
            font-size: 13px;
            color: #667eea;
            text-decoration: none;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        .source-site {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            position: relative;
        }

        .input-box textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            font-size: 14px;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            line-height: 1.5;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-box textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-box textarea::placeholder {
            color: #adb5bd;
        }

        .send-btn {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Ê¨¢ËøéÊ∂àÊÅØ */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .welcome-message h2 {
            font-size: 20px;
            color: #495057;
            margin-bottom: 8px;
        }

        .welcome-message p {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .quick-question {
            padding: 8px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 13px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-question:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9ff;
        }

        /* RAGÂàÜÊï∞ÊåáÁ§∫Âô® */
        .rag-score {
            font-size: 10px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-history svg {
            width: 48px;
            height: 48px;
            color: #3d3d5c;
            margin-bottom: 12px;
        }

        .empty-history p {
            font-size: 13px;
        }

        /* ÁßªÂä®Á´Ø‰æßËæπÊ†èÂàáÊç¢ÊåâÈíÆ */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 40px;
            height: 40px;
            background: #1a1a2e;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 900px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: flex;
            }

            .main-content {
                padding-left: 20px;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
            }

            .sidebar-overlay.open {
                display: block;
            }
        }

        @media (max-width: 600px) {
            .toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .school-selector {
                justify-content: space-between;
            }

            .toolbar-actions {
                justify-content: flex-end;
            }

            .message-bubble {
                max-width: 90%;
            }

            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ÁßªÂä®Á´Ø‰æßËæπÊ†èÂàáÊç¢ÊåâÈíÆ -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
        </button>

        <!-- ‰æßËæπÊ†èÈÅÆÁΩ© -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    New Chat
                </button>
            </div>

            <div class="history-list" id="historyList">
                <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂ∞ÜÂä®ÊÄÅÂä†ËΩΩ -->
            </div>

            <div class="sidebar-footer">
                <div class="storage-info" id="storageInfo">0 conversations stored</div>
                <button class="clear-all-btn" onclick="clearAllHistory()">Clear All History</button>
            </div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <div class="main-content">
            <div class="header">
                <h1>Campus AI Assistant</h1>
                <p>Intelligent Q&A System with RAG Knowledge Base + Web Search</p>
            </div>

            <div class="chat-container">
                <!-- Â∑•ÂÖ∑Ê†è -->
                <div class="toolbar">
                    <div class="school-selector">
                        <label for="school">School:</label>
                        <select id="school">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="session-info" id="sessionInfo"></div>
                    <div class="toolbar-actions">
                        <button class="btn-icon" onclick="clearCurrentChat()" title="Clear current chat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message" id="welcomeMessage">
                        <h2>Welcome to Campus AI Assistant</h2>
                        <p>Please select a school first, then enter your question</p>
                        <div class="quick-questions">
                            <button class="quick-question" onclick="askQuickQuestion('When is the SIR deadline?')">SIR Deadline</button>
                            <button class="quick-question" onclick="askQuickQuestion('How much is the housing deposit?')">Housing Deposit</button>
                            <button class="quick-question" onclick="askQuickQuestion('How to apply for on-campus housing?')">Housing Application</button>
                            <button class="quick-question" onclick="askQuickQuestion('When is the new student orientation?')">New Student Orientation</button>
                        </div>
                    </div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="input-area">
                    <div class="input-wrapper">
                        <div class="input-box">
                            <textarea
                                id="questionInput"
                                placeholder="Enter your question... (Enter to send, Shift+Enter for new line)"
                                rows="1"
                            ></textarea>
                        </div>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8087';
            // Use the current page origin so fetches work when the app is forwarded
            // (e.g. in Codespaces / app.github.dev) instead of always requesting localhost.
            const BASE_URL = window.location.origin;

            // Fallback schools list used if fetching `/schools` fails (prevents "Load Failed").
            const DEFAULT_SCHOOLS = {
                'UCI': { name: 'UC Irvine', name_cn: 'UC Irvine', file: 'UCI', deptId: 215 },
                'UCSD': { name: 'UC San Diego', name_cn: 'UC San Diego', file: 'UCSD', deptId: 216 },
                'NYU': { name: 'New York University', name_cn: 'New York University', file: 'NYUCU', deptId: 226 },
                'OSU': { name: 'Ohio State University', name_cn: 'Ohio State University', file: 'OSUCU', deptId: null },
                'UCB': { name: 'UC Berkeley', name_cn: 'UC Berkeley', file: 'UCBCU', deptId: 211 },
                'UCLA': { name: 'UC Los Angeles', name_cn: 'UC Los Angeles', file: 'UCLACU', deptId: 214 },
                'UPenn': { name: 'University of Pennsylvania', name_cn: 'University of Pennsylvania', file: 'UPennCU', deptId: null },
                'USC': { name: 'University of Southern California', name_cn: 'University of Southern California', file: 'USCCU', deptId: 213 },
                'UW': { name: 'University of Washington', name_cn: 'University of Washington', file: 'UWCU', deptId: 218 },
                'Cornell': { name: 'Cornell University', name_cn: 'Cornell University', file: 'Cornell', deptId: 300 }
            };

        let currentSessionId = '';
        let currentDeptId = '';
        let currentSchoolId = '';
        let schoolsData = {};
        let isLoading = false;
        let chatHistory = [];  // ÂΩìÂâçÂØπËØùÁöÑÊ∂àÊÅØÂàóË°®

        // ==================== ÂàùÂßãÂåñ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure the selector is pre-populated synchronously to avoid a persistent "Loading..." state
            populatePreferredSchools();
            loadSchools();
            setupTextarea();
            loadHistoryList();
        });

        function populatePreferredSchools() {
            const select = document.getElementById('school');
            select.innerHTML = '<option value="">-- Select School --</option>';
            const SELECT_SCHOOLS = ['UCB', 'UCLA', 'UCSD', 'UCI', 'Cornell'];
            for (const id of SELECT_SCHOOLS) {
                const info = DEFAULT_SCHOOLS[id];
                if (!info) continue;
                const option = document.createElement('option');
                option.value = info.deptId || '';
                option.dataset.schoolId = id;
                option.textContent = `${info.name} (${id})`;
                select.appendChild(option);
            }
        }

        // ==================== Â≠¶Ê†°Áõ∏ÂÖ≥ ====================
        async function loadSchools() {
            const select = document.getElementById('school');
            // Ensure we show a loading state then replace it later
            select.innerHTML = '<option value="">Loading...</option>';

            // Abort fetch after timeout to avoid hanging the UI
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 2000);

            try {
                const response = await fetch(`${BASE_URL}/schools`, { signal: controller.signal });
                clearTimeout(timeout);
                const data = await response.json();
                schoolsData = data.schools || {};

                select.innerHTML = '<option value="">-- Select School --</option>';
                const SELECT_SCHOOLS = ['UCB', 'UCLA', 'UCSD', 'UCI', 'Cornell'];
                for (const id of SELECT_SCHOOLS) {
                    const info = (data.schools && data.schools[id]) || DEFAULT_SCHOOLS[id];
                    if (!info) continue;
                    const option = document.createElement('option');
                    option.value = info.deptId || '';
                    option.dataset.schoolId = id;
                    option.textContent = `${info.name} (${id})`;
                    select.appendChild(option);
                }

                select.addEventListener('change', function() {
                    currentDeptId = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    currentSchoolId = selectedOption.dataset.schoolId || '';

                    const info = (schoolsData && schoolsData[currentSchoolId]) || DEFAULT_SCHOOLS[currentSchoolId] || {};
                    const welcomeH2 = document.querySelector('#welcomeMessage h2');
                    if (welcomeH2) {
                        welcomeH2.textContent = `Welcome to ${info.name || currentSchoolId} AI Assistant`;
                    }

                    saveCurrentChat();
                });
            } catch (error) {
                // fetch failed or timed out; populate curated fallback so user can choose
                console.error('Failed to load schools (fetch error or timeout):', error);
                select.innerHTML = '<option value="">-- Select School --</option>';
                const SELECT_SCHOOLS = ['UCB', 'UCLA', 'UCSD', 'UCI', 'Cornell'];
                for (const id of SELECT_SCHOOLS) {
                    const info = DEFAULT_SCHOOLS[id];
                    if (!info) continue;
                    const option = document.createElement('option');
                    option.value = info.deptId || '';
                    option.dataset.schoolId = id;
                    option.textContent = `${info.name} (${id})`;
                    select.appendChild(option);
                }
                select.addEventListener('change', function() {
                    currentDeptId = this.value || '';
                    const selectedOption = this.options[this.selectedIndex];
                    currentSchoolId = selectedOption.dataset.schoolId || '';
                    const info = DEFAULT_SCHOOLS[currentSchoolId] || {};
                    const welcomeH2 = document.querySelector('#welcomeMessage h2');
                    if (welcomeH2) {
                        welcomeH2.textContent = `Welcome to ${info.name || currentSchoolId} AI Assistant`;
                    }
                    saveCurrentChat();
                });
            }
        }

        // ==================== ÂêéÁ´ØAPIÂ≠òÂÇ® ====================
        let allChatsCache = [];  // ÁºìÂ≠òËÅäÂ§©ÂàóË°®

        async function getAllChats() {
            try {
                const response = await fetch(`${BASE_URL}/chat-history`);
                const data = await response.json();
                allChatsCache = data.chats || [];
                return allChatsCache;
            } catch (error) {
                console.error('Ëé∑ÂèñËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error);
                return allChatsCache;
            }
        }

        async function saveCurrentChat() {
            if (!currentSessionId || chatHistory.length === 0) return;

            const chatData = {
                sessionId: currentSessionId,
                deptId: currentDeptId,
                schoolId: currentSchoolId,
                schoolName: schoolsData[currentSchoolId]?.name || currentSchoolId,
                title: chatHistory[0]?.content?.substring(0, 30) || 'New Chat',
                messages: chatHistory,
                updatedAt: Date.now(),
                createdAt: Date.now()
            };

            try {
                await fetch(`${BASE_URL}/chat-history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chatData)
                });
                await loadHistoryList();
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error);
            }
        }

        async function loadChat(sessionId) {
            // ÂÖà‰øùÂ≠òÂΩìÂâçÂØπËØù
            await saveCurrentChat();

            const chats = await getAllChats();
            const chat = chats.find(c => c.sessionId === sessionId);

            if (!chat) return;

            // ËÆæÁΩÆÂΩìÂâç‰ºöËØù
            currentSessionId = chat.sessionId;
            currentDeptId = chat.deptId;
            currentSchoolId = chat.schoolId;
            chatHistory = chat.messages || [];

            // Êõ¥Êñ∞Â≠¶Ê†°ÈÄâÊã©Âô®
            const select = document.getElementById('school');
            select.value = currentDeptId;

            // Êõ¥Êñ∞ÁïåÈù¢
            updateSessionInfo();
            renderMessages();
            await loadHistoryList();

            // ÁßªÂä®Á´ØÂÖ≥Èó≠‰æßËæπÊ†è
            if (window.innerWidth <= 900) {
                toggleSidebar();
            }
        }

        async function deleteChat(sessionId, event) {
            event.stopPropagation();
            if (!confirm('Are you sure you want to delete this conversation?')) return;

            try {
                await fetch(`${BASE_URL}/chat-history/${sessionId}`, {
                    method: 'DELETE'
                });

                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØùÔºåÂºÄÂßãÊñ∞ÂØπËØù
                if (sessionId === currentSessionId) {
                    startNewChat();
                }

                await loadHistoryList();
            } catch (error) {
                console.error('Âà†Èô§ËÅäÂ§©Â§±Ë¥•:', error);
            }
        }

        async function clearAllHistory() {
            if (!confirm('Are you sure you want to clear all history? This action cannot be undone!')) return;

            try {
                await fetch(`${BASE_URL}/chat-history/clear`, {
                    method: 'DELETE'
                });
                startNewChat();
                await loadHistoryList();
            } catch (error) {
                console.error('Ê∏ÖÈô§ÂéÜÂè≤Â§±Ë¥•:', error);
            }
        }

        // ==================== ÂéÜÂè≤ÂàóË°®Ê∏≤Êüì ====================
        async function loadHistoryList() {
            const listDiv = document.getElementById('historyList');
            const chats = await getAllChats();
            updateStorageInfo(chats.length);

            if (chats.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-history">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                        </svg>
                        <p>No chat history</p>
                    </div>
                `;
                return;
            }

            // ÊåâÊó∂Èó¥ÂàÜÁªÑ
            const now = Date.now();
            const today = [];
            const yesterday = [];
            const thisWeek = [];
            const older = [];

            const dayMs = 24 * 60 * 60 * 1000;
            const todayStart = new Date().setHours(0, 0, 0, 0);

            chats.forEach(chat => {
                const chatTime = chat.updatedAt || chat.createdAt;
                if (chatTime >= todayStart) {
                    today.push(chat);
                } else if (chatTime >= todayStart - dayMs) {
                    yesterday.push(chat);
                } else if (chatTime >= todayStart - 7 * dayMs) {
                    thisWeek.push(chat);
                } else {
                    older.push(chat);
                }
            });

            let html = '';

            if (today.length > 0) {
                html += renderHistorySection('Today', today);
            }
            if (yesterday.length > 0) {
                html += renderHistorySection('Yesterday', yesterday);
            }
            if (thisWeek.length > 0) {
                html += renderHistorySection('This Week', thisWeek);
            }
            if (older.length > 0) {
                html += renderHistorySection('Older', older);
            }

            listDiv.innerHTML = html;
        }

        function renderHistorySection(title, chats) {
            let html = `
                <div class="history-section">
                    <div class="history-section-title">${title}</div>
            `;

            chats.forEach(chat => {
                const isActive = chat.sessionId === currentSessionId;
                html += `
                    <div class="history-item ${isActive ? 'active' : ''}" onclick="loadChat('${chat.sessionId}')">
                        <div class="history-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                            </svg>
                        </div>
                        <div class="history-item-content">
                            <div class="history-item-title">${escapeHtml(chat.title)}</div>
                            <div class="history-item-meta">
                                <span class="history-item-school">${chat.schoolName || chat.schoolId}</span>
                                <span>${formatTime(chat.updatedAt || chat.createdAt)}</span>
                            </div>
                        </div>
                        <button class="history-item-delete" onclick="deleteChat('${chat.sessionId}', event)" title="Delete">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function updateStorageInfo(count) {
            document.getElementById('storageInfo').textContent = `${count || 0} conversations stored`;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;

            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // ==================== ËÅäÂ§©ÂäüËÉΩ ====================
        async function startNewChat() {
            // ‰øùÂ≠òÂΩìÂâçÂØπËØù
            await saveCurrentChat();

            // ÈáçÁΩÆÁä∂ÊÄÅ
            currentSessionId = generateSessionId();
            chatHistory = [];

            // Êõ¥Êñ∞ÁïåÈù¢
            document.getElementById('sessionInfo').textContent = '';
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-message" id="welcomeMessage">
                    <h2>Welcome to${currentSchoolId ? ' ' + schoolsData[currentSchoolId]?.name : ''} AI Assistant</h2>
                    <p>Please select a school first, then enter your question</p>
                    <div class="quick-questions">
                        <button class="quick-question" onclick="askQuickQuestion('When is the SIR deadline?')">SIR Deadline</button>
                        <button class="quick-question" onclick="askQuickQuestion('How much is the housing deposit?')">Housing Deposit</button>
                        <button class="quick-question" onclick="askQuickQuestion('How to apply for on-campus housing?')">Housing Application</button>
                        <button class="quick-question" onclick="askQuickQuestion('When is the new student orientation?')">New Student Orientation</button>
                    </div>
                </div>
            `;

            await loadHistoryList();

            // ÁßªÂä®Á´ØÂÖ≥Èó≠‰æßËæπÊ†è
            if (window.innerWidth <= 900) {
                toggleSidebar();
            }
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function sendMessage() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();

            if (!question || isLoading) return;

            if (!currentDeptId) {
                alert('Please select a school first');
                return;
            }

            // Hide welcome message
            const welcome = document.getElementById('welcomeMessage');
            if (welcome) welcome.style.display = 'none';

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÂéÜÂè≤
            chatHistory.push({
                role: 'user',
                content: question,
                timestamp: Date.now()
            });

            // Ê∏≤ÊüìÁî®Êà∑Ê∂àÊÅØ
            addMessageToUI('user', question);
            input.value = '';
            input.style.height = 'auto';

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            showLoading();
            isLoading = true;
            document.getElementById('sendBtn').disabled = true;

            try {
                // Build payload: prefer deptId if available, otherwise send school_id
                const payload = { question: question, session_id: currentSessionId };
                if (currentDeptId) payload.deptId = currentDeptId;
                else if (currentSchoolId) payload.school_id = currentSchoolId;

                const response = await fetch(`${BASE_URL}/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                hideLoading();

                if (data.error) {
                    addMessageToUI('assistant', `Error: ${data.error}`, null, null);
                } else {
                    currentSessionId = data.session_id;
                    updateSessionInfo();

                    // Ê∑ªÂä†Âä©ÊâãÊ∂àÊÅØÂà∞ÂéÜÂè≤
                    chatHistory.push({
                        role: 'assistant',
                        content: data.answer,
                        sourceType: data.source_type,
                        webSources: data.web_sources,
                        ragScore: data.rag_score,
                        timestamp: Date.now()
                    });

                    addMessageToUI('assistant', data.answer, data.source_type, data.web_sources, data.rag_score);

                    // ‰øùÂ≠òÂØπËØù
                    saveCurrentChat();
                }
            } catch (error) {
                hideLoading();
                addMessageToUI('assistant', `Request failed: ${error.message}`, null, null);
            }

            isLoading = false;
            document.getElementById('sendBtn').disabled = false;
        }

        function renderMessages() {
            const messagesDiv = document.getElementById('chatMessages');

            if (chatHistory.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="welcome-message" id="welcomeMessage">
                        <h2>Welcome to${currentSchoolId ? ' ' + schoolsData[currentSchoolId]?.name : ''} AI Assistant</h2>
                        <p>Please select a school first, then enter your question</p>
                        <div class="quick-questions">
                            <button class="quick-question" onclick="askQuickQuestion('When is the SIR deadline?')">SIR Deadline</button>
                            <button class="quick-question" onclick="askQuickQuestion('How much is the housing deposit?')">Housing Deposit</button>
                            <button class="quick-question" onclick="askQuickQuestion('How to apply for on-campus housing?')">Housing Application</button>
                            <button class="quick-question" onclick="askQuickQuestion('When is the new student orientation?')">New Student Orientation</button>
                        </div>
                    </div>
                `;
                return;
            }

            messagesDiv.innerHTML = '';
            chatHistory.forEach(msg => {
                if (msg.role === 'user') {
                    addMessageToUI('user', msg.content);
                } else {
                    addMessageToUI('assistant', msg.content, msg.sourceType, msg.webSources, msg.ragScore);
                }
            });
        }

        function addMessageToUI(role, content, sourceType, webSources, ragScore) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let formattedContent = content;
            if (role === 'assistant' && webSources) {
                formattedContent = content.replace(/\[(\d+)\]/g, '<sup>[$1]</sup>');
            }

            let html = `<div class="message-bubble">${formatContent(formattedContent)}</div>`;

            if (role === 'assistant') {
                let metaHtml = '<div class="message-meta">';

                if (sourceType === 'knowledge_base') {
                    metaHtml += '<span class="source-badge knowledge-base">üìö Knowledge Base</span>';
                } else if (sourceType === 'web_search') {
                    metaHtml += '<span class="source-badge web-search">üåê Web Search</span>';
                }

                if (ragScore !== undefined && ragScore !== null) {
                    metaHtml += `<span class="rag-score">Relevance: ${(ragScore * 100).toFixed(0)}%</span>`;
                }

                metaHtml += '</div>';
                html += metaHtml;

                // Only show sources section if there are actual search results
                if (webSources && webSources.search_results && webSources.search_results.length > 0) {
                    html += buildSourcesHtml(webSources.search_results);
                }
            }

            messageDiv.innerHTML = html;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function buildSourcesHtml(sources) {
            let html = '<div class="sources-container">';
            html += '<div class="sources-title"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> References</div>';

            sources.forEach(source => {
                html += `
                    <div class="source-item">
                        <span class="source-index">${source.index}</span>
                        <div class="source-content">
                            <a href="${source.url}" target="_blank" class="source-link">${escapeHtml(source.title)}</a>
                            <div class="source-site">${escapeHtml(source.site_name)}</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================
        function setupTextarea() {
            const textarea = document.getElementById('questionInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function formatContent(content) {
            // Simple Markdown rendering
            let html = content
                // Escape HTML first
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Restore sup tags for citations
            html = html
                .replace(/&lt;sup&gt;/g, '<sup>')
                .replace(/&lt;\/sup&gt;/g, '</sup>');

            // Bold: **text** or __text__
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');

            // Italic: *text* or _text_
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

            // Inline code: `code`
            html = html.replace(/`([^`]+)`/g, '<code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>');

            // Headers: ### Header
            html = html.replace(/^### (.+)$/gm, '<h4 style="margin: 16px 0 8px 0; font-size: 15px; font-weight: 600;">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 style="margin: 16px 0 8px 0; font-size: 16px; font-weight: 600;">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 style="margin: 16px 0 8px 0; font-size: 18px; font-weight: 600;">$1</h2>');

            // Unordered lists: - item or * item
            html = html.replace(/^[\-\*] (.+)$/gm, '<li style="margin-left: 20px; list-style-type: disc;">$1</li>');

            // Ordered lists: 1. item
            html = html.replace(/^\d+\. (.+)$/gm, '<li style="margin-left: 20px; list-style-type: decimal;">$1</li>');

            // Links: [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: none;">$1</a>');

            // Horizontal rule: --- or ***
            html = html.replace(/^[\-\*]{3,}$/gm, '<hr style="margin: 12px 0; border: none; border-top: 1px solid #e0e0e0;">');

            // Tables: | col1 | col2 |
            html = html.replace(/^\|(.+)\|$/gm, function(match, content) {
                const cells = content.split('|').map(cell => cell.trim());
                const isHeader = cells.every(cell => /^[\-:]+$/.test(cell));
                if (isHeader) return ''; // Skip separator row
                const cellHtml = cells.map(cell => `<td style="padding: 8px 12px; border: 1px solid #ddd;">${cell}</td>`).join('');
                return `<tr>${cellHtml}</tr>`;
            });

            // Wrap consecutive table rows
            html = html.replace(/(<tr>.*?<\/tr>\s*)+/g, function(match) {
                return `<table style="border-collapse: collapse; margin: 12px 0; width: 100%;">${match}</table>`;
            });

            // Newlines to <br>
            html = html.replace(/\n/g, '<br>');

            // Clean up multiple <br> tags
            html = html.replace(/(<br>\s*){3,}/g, '<br><br>');

            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span style="font-size: 13px; color: #6c757d;">AI is thinking...</span>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        function updateSessionInfo() {
            const info = document.getElementById('sessionInfo');
            if (currentSessionId) {
                info.textContent = `Session: ${currentSessionId.substring(0, 12)}...`;
            }
        }

        function askQuickQuestion(question) {
            if (!currentDeptId) {
                alert('Please select a school first');
                return;
            }
            document.getElementById('questionInput').value = question;
            sendMessage();
        }

        async function clearCurrentChat() {
            if (chatHistory.length === 0) {
                alert('No conversation to clear');
                return;
            }

            if (!confirm('Are you sure you want to clear the current conversation?')) return;

            try {
                // ‰ªéÂêéÁ´ØÂà†Èô§ËÅäÂ§©ÂéÜÂè≤
                await fetch(`${BASE_URL}/chat-history/${currentSessionId}`, {
                    method: 'DELETE'
                });

                // Ê∏ÖÈô§ÊúçÂä°Á´Ø‰ºöËØù
                await fetch(`${BASE_URL}/clear/${currentSessionId}`, { method: 'DELETE' });
            } catch (e) {
                console.error('Ê∏ÖÈô§ÂØπËØùÂ§±Ë¥•:', e);
            }

            // ÂºÄÂßãÊñ∞ÂØπËØù
            await startNewChat();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
    </script>
</body>
</html>
