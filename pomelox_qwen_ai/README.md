# å¯¹æ¥åƒé—®APIçš„Pythoné¡¹ç›®ï¼ˆRAG + è”ç½‘æœç´¢ + deptId é›†æˆï¼‰

## é¡¹ç›®ä»‹ç»

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºFlaskçš„WebæœåŠ¡ï¼Œæä¾›äº†ä¸åƒé—®APIå¯¹æ¥çš„åŠŸèƒ½ï¼Œé›†æˆäº†ä»¥ä¸‹æ ¸å¿ƒæŠ€æœ¯ï¼š

- **RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰**ï¼šåŸºäºå­¦æ ¡çŸ¥è¯†åº“çš„æ™ºèƒ½é—®ç­”
- **è”ç½‘æœç´¢å…œåº•**ï¼šå½“çŸ¥è¯†åº“ç›¸å…³æ€§ä¸è¶³æ—¶è‡ªåŠ¨å¯ç”¨è”ç½‘æœç´¢
- **deptId è‡ªåŠ¨æ˜ å°„**ï¼šé€šè¿‡ç”¨æˆ·éƒ¨é—¨IDè‡ªåŠ¨åŒ¹é…å¯¹åº”å­¦æ ¡
- **å¤šè½®å¯¹è¯**ï¼šæ”¯æŒä¼šè¯ç®¡ç†å’Œä¸Šä¸‹æ–‡è®°å¿†

### æ ¸å¿ƒåŠŸèƒ½
1. æé—®AIå›ç­”æ¥å£ï¼ˆRAGä¼˜å…ˆ + è”ç½‘æœç´¢å…œåº•ï¼‰
2. æŸ¥è¯¢å¯¹è¯å†å²æ¥å£
3. æ¸…é™¤ä¼šè¯è®°å½•æ¥å£
4. è·å–å­¦æ ¡åˆ—è¡¨æ¥å£
5. å¥åº·æ£€æŸ¥æ¥å£

---

## é‡è¦ï¼šæ¥å£å‚æ•°å˜æ›´

### v3.0 å˜æ›´è¯´æ˜

| å˜æ›´é¡¹ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|--------|--------|--------|
| å­¦æ ¡æ ‡è¯†å‚æ•° | `school_id` (å¦‚ "UCLA") | `deptId` (å¦‚ 214) |
| å‚æ•°æ¥æº | å‰ç«¯æ‰‹åŠ¨ä¼ å…¥ | ä»ç”¨æˆ·ä¿¡æ¯æ¥å£è·å– |

### ä¸ºä»€ä¹ˆæ”¹ç”¨ deptIdï¼Ÿ

åœ¨å®é™… App ä¸­ï¼Œç”¨æˆ·ç™»å½•åç³»ç»Ÿå·²çŸ¥ç”¨æˆ·æ‰€å±å­¦æ ¡ï¼ˆé€šè¿‡ `/app/user/info` çš„ `deptId`ï¼‰ã€‚App åªéœ€é€ä¼  `deptId`ï¼Œåç«¯è‡ªåŠ¨æ˜ å°„åˆ°å¯¹åº”å­¦æ ¡çŸ¥è¯†åº“ã€‚

### deptId ä¸å­¦æ ¡æ˜ å°„è¡¨

| deptId | school_id | å­¦æ ¡åç§° |
|--------|-----------|---------|
| 211 | UCB | åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡ |
| 213 | USC | å—åŠ å·å¤§å­¦ |
| 214 | UCLA | åŠ å·å¤§å­¦æ´›æ‰çŸ¶åˆ†æ ¡ |
| 216 | UCSD | åŠ å·å¤§å­¦åœ£åœ°äºšå“¥åˆ†æ ¡ |
| 218 | UW | åç››é¡¿å¤§å­¦ |
| 226 | NYU | çº½çº¦å¤§å­¦ |

---

## æ™ºèƒ½å›ç­”æœºåˆ¶

```
ç”¨æˆ·æé—® + deptId
       â†“
   deptId â†’ school_id æ˜ å°„
       â†“
   RAG æ£€ç´¢çŸ¥è¯†åº“
       â†“
  è¯„ä¼°æ£€ç´¢è´¨é‡ (rag_score)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  rag_score >= 0.5                â”‚
â”‚  â†’ ä½¿ç”¨çŸ¥è¯†åº“å†…å®¹å›ç­”            â”‚
â”‚  â†’ source_type: knowledge_base   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rag_score < 0.5                 â”‚
â”‚  â†’ å¯ç”¨è”ç½‘æœç´¢                  â”‚
â”‚  â†’ source_type: web_search       â”‚
â”‚  â†’ è¿”å›å¼•ç”¨æ¥æºé“¾æ¥              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®‰è£…ä¾èµ–

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä½¿ç”¨è™šæ‹Ÿç¯å¢ƒï¼‰
# Windows:
venv\Scripts\activate

# å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt
```

å¦‚æœé‡åˆ°ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºï¼š
```bash
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
```

## é…ç½®è¯´æ˜

1. è·å–åƒé—®API Key:
   - è®¿é—®é˜¿é‡Œäº‘å®˜ç½‘æ§åˆ¶å°
   - è¿›å…¥DashScopeç®¡ç†é¡µé¢
   - åˆ›å»ºå¹¶è·å–API Key

2. è®¾ç½®API Key:
   - å¤åˆ¶`.env.example`æ–‡ä»¶ä¸º`.env`
   - åœ¨`.env`æ–‡ä»¶ä¸­å¡«å†™æ‚¨çš„å®é™…APIå¯†é’¥

## å¯åŠ¨æœåŠ¡

```bash
python app.py
```

æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ `http://localhost:8087`

---

## API æ¥å£è¯´æ˜

### 1. æé—®AIæ¥å£ï¼ˆæ ¸å¿ƒæ¥å£ï¼‰

- **URL**: `/ask`
- **æ–¹æ³•**: POST
- **è¯·æ±‚å‚æ•°**:
  ```json
  {
    "question": "UCLAçš„SIRæˆªæ­¢æ—¥æœŸæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ",
    "deptId": 214,
    "session_id": "å¯é€‰çš„ä¼šè¯ID"
  }
  ```

- **å“åº”ï¼ˆçŸ¥è¯†åº“å›ç­”ï¼‰**:
  ```json
  {
    "session_id": "ä¼šè¯ID",
    "school_id": "UCLA",
    "question": "UCLAçš„SIRæˆªæ­¢æ—¥æœŸæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ",
    "answer": "åŠ å·å¤§å­¦æ´›æ‰çŸ¶åˆ†æ ¡ï¼ˆUCLAï¼‰çš„SIRæˆªæ­¢æ—¥æœŸæ˜¯2024å¹´5æœˆ15æ—¥...",
    "source_type": "knowledge_base",
    "rag_score": 0.621
  }
  ```

- **å“åº”ï¼ˆè”ç½‘æœç´¢å›ç­”ï¼‰**:
  ```json
  {
    "session_id": "ä¼šè¯ID",
    "school_id": "UCLA",
    "question": "2024å¹´ç¾å›½æ€»ç»Ÿå¤§é€‰ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ",
    "answer": "2024å¹´ç¾å›½æ€»ç»Ÿå¤§é€‰ä¸­ï¼Œå…±å’Œå…šå€™é€‰äººç‰¹æœ—æ™®å®£å¸ƒè·èƒœ[1][2]...",
    "source_type": "web_search",
    "rag_score": 0.279,
    "web_sources": {
      "search_results": [
        {
          "index": 1,
          "title": "2024å¹´ç¾åˆ©åšåˆä¼—å›½æ€»ç»Ÿé€‰ä¸¾",
          "url": "https://baike.baidu.com/...",
          "site_name": "ç™¾åº¦ç™¾ç§‘"
        }
      ]
    }
  }
  ```

### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ |
|------|------|
| source_type | å›ç­”æ¥æºï¼š`knowledge_base`ï¼ˆçŸ¥è¯†åº“ï¼‰æˆ– `web_search`ï¼ˆè”ç½‘æœç´¢ï¼‰|
| rag_score | RAG æ£€ç´¢ç›¸å…³æ€§åˆ†æ•°ï¼ˆ0-1ï¼‰ï¼Œè¶Šé«˜è¡¨ç¤ºçŸ¥è¯†åº“åŒ¹é…åº¦è¶Šå¥½ |
| web_sources | è”ç½‘æœç´¢æ¥æºä¿¡æ¯ï¼ˆä»…å½“ source_type ä¸º web_search æ—¶å­˜åœ¨ï¼‰|

### è”ç½‘æœç´¢å¼•ç”¨å¤„ç†

å½“ `source_type` ä¸º `web_search` æ—¶ï¼Œå›ç­”ä¸­çš„ `[1][2]` ç­‰æ ‡è®°å¯¹åº” `web_sources.search_results` ä¸­çš„æ¥æºã€‚

**å‰ç«¯å¤„ç†ç¤ºä¾‹**ï¼š
```javascript
// å°† [1] è½¬æ¢ä¸ºä¸Šæ ‡æ ¼å¼
let formattedAnswer = data.answer.replace(/\[(\d+)\]/g, '<sup>[$1]</sup>');

// å±•ç¤ºæ¥æºå¡ç‰‡
if (data.web_sources) {
    data.web_sources.search_results.forEach(source => {
        // source.index: ç¼–å·
        // source.title: æ ‡é¢˜
        // source.url: é“¾æ¥ï¼ˆå¯ç‚¹å‡»ï¼‰
        // source.site_name: ç½‘ç«™åç§°
    });
}
```

### 2. è·å–å­¦æ ¡åˆ—è¡¨æ¥å£

- **URL**: `/schools`
- **æ–¹æ³•**: GET
- **å“åº”**:
  ```json
  {
    "schools": {
      "UCLA": {"name": "UC Los Angeles", "name_cn": "åŠ å·å¤§å­¦æ´›æ‰çŸ¶åˆ†æ ¡", "file": "UCLACU", "deptId": 214},
      ...
    }
  }
  ```

### 3. æŸ¥è¯¢å¯¹è¯å†å²æ¥å£

- **URL**: `/history/<session_id>`
- **æ–¹æ³•**: GET

### 4. æ¸…é™¤ä¼šè¯è®°å½•æ¥å£

- **URL**: `/clear/<session_id>`
- **æ–¹æ³•**: DELETE

### 5. å¥åº·æ£€æŸ¥æ¥å£

- **URL**: `/health`
- **æ–¹æ³•**: GET

---

## App ç«¯é›†æˆæŒ‡å—

### è°ƒç”¨æµç¨‹

```
1. ç”¨æˆ·ç™»å½• App
       â†“
2. è°ƒç”¨ /app/user/info è·å–ç”¨æˆ·ä¿¡æ¯
       â†“
3. æå– deptIdï¼ˆå¦‚ 214ï¼‰
       â†“
4. ç”¨æˆ·æé—®æ—¶ï¼Œå‘é€è¯·æ±‚åˆ° /askï¼š
   {
     "question": "ç”¨æˆ·çš„é—®é¢˜",
     "deptId": 214
   }
       â†“
5. å¤„ç†å“åº”ï¼Œå±•ç¤ºå›ç­”
```

### ç¤ºä¾‹ä»£ç 

```javascript
// ä»ç”¨æˆ·ä¿¡æ¯è·å– deptId
const userInfo = await getUserInfo();
const deptId = userInfo.deptId;  // å¦‚ 214

// æé—®AI
const response = await fetch('http://your-server:8087/ask', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        question: 'ä½æˆ¿ç”³è¯·æˆªæ­¢æ—¥æœŸæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ',
        deptId: deptId
    })
});

const data = await response.json();

// å¤„ç†å›ç­”
if (data.source_type === 'web_search' && data.web_sources) {
    // å¤„ç†è”ç½‘æœç´¢å¼•ç”¨
    let answer = data.answer.replace(/\[(\d+)\]/g, '<sup>[$1]</sup>');
    showSourceCards(data.web_sources.search_results);
}
```

---

## å‰ç«¯æ¼”ç¤º

é¡¹ç›®åŒ…å«ä¸€ä¸ªæµ‹è¯•ç”¨å‰ç«¯æ¼”ç¤ºé¡µé¢ `index.html`ï¼š

1. å¯åŠ¨æœåŠ¡åï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `index.html` æ–‡ä»¶
2. ä»ä¸‹æ‹‰èœå•é€‰æ‹©å­¦æ ¡ï¼ˆä»…æ˜¾ç¤ºæœ‰ deptId çš„å­¦æ ¡ï¼‰
3. è¾“å…¥é—®é¢˜æˆ–ç‚¹å‡»å¿«é€Ÿé—®é¢˜æŒ‰é’®
4. æŸ¥çœ‹AIå›ç­”ã€æ¥æºç±»å‹å’Œå¼•ç”¨é“¾æ¥

### å‰ç«¯åŠŸèƒ½
- å­¦æ ¡é€‰æ‹©ä¸‹æ‹‰èœå•ï¼ˆè‡ªåŠ¨è¿‡æ»¤æœ‰ deptId çš„å­¦æ ¡ï¼‰
- ç°ä»£åŒ–èŠå¤©æ°”æ³¡ç•Œé¢
- æ¥æºç±»å‹å¾½ç« ï¼ˆğŸ“š çŸ¥è¯†åº“ / ğŸŒ è”ç½‘æœç´¢ï¼‰
- RAG ç›¸å…³åº¦ç™¾åˆ†æ¯”æ˜¾ç¤º
- è”ç½‘æœç´¢æ¥æºå¡ç‰‡ï¼ˆå¯ç‚¹å‡»é“¾æ¥ï¼‰

---

## å¸¸è§é—®é¢˜

### 1. "400 Bad Request: deptId ä¸èƒ½ä¸ºç©º"

è¯·åœ¨è¯·æ±‚ä¸­æ·»åŠ  `deptId` å‚æ•°ï¼š
```json
{
  "question": "ä½ çš„é—®é¢˜",
  "deptId": 214
}
```

### 2. "æœªæ‰¾åˆ°éƒ¨é—¨IDå¯¹åº”çš„å­¦æ ¡"

è¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ deptIdï¼Œå¯ç”¨çš„ deptIdï¼š211, 213, 214, 216, 218, 226

### 3. ä¸ºä»€ä¹ˆæˆ‘çš„é—®é¢˜è§¦å‘äº†è”ç½‘æœç´¢ï¼Ÿ

å½“é—®é¢˜ä¸çŸ¥è¯†åº“å†…å®¹ç›¸å…³æ€§è¾ƒä½ï¼ˆ`rag_score < 0.5`ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯ç”¨è”ç½‘æœç´¢ã€‚

---

## æ–‡æ¡£

- [API æ¥å£æ–‡æ¡£](API_DOCUMENTATION.md)
- [RAG æ›´æ–°è¯´æ˜](RAG_UPDATE.md)
- [é¡¹ç›®ç»“æ„è¯´æ˜](PROJECT_STRUCTURE.md)
